#!/bin/sh
#
# MAVLink startup script.
#
# NOTE: Script variables are declared/initialized/unset in the rcS script.
#

<<<<<<< HEAD
if ! ver hwcmp INTEL_AEROFC_V1
then
	# Start MAVLink on the USB port
=======
if ver hwcmp AEROFC_V1
then
	# don't start mavlink ttyACM0 on aerofc_v1
else
	# Start MAVLink
>>>>>>> 97f14edcbd3ff8526326d26d749656a8e8f309c9
	mavlink start -r 800000 -d /dev/ttyACM0 -m config -x
fi

#
# SYS_COMPANION transition support. Can be removed after the next release (currently at 1.8.0)
#
if param compare SYS_COMPANION 319200
then
<<<<<<< HEAD
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 1000
	param set SER_TEL2_BAUD 19200
	param set SYS_COMPANION 0
=======
	set MAVLINK_COMPANION_DEVICE /dev/ttyS4
>>>>>>> 97f14edcbd3ff8526326d26d749656a8e8f309c9
fi
if param compare SYS_COMPANION 519200
then
	param set MAV_1_CONFIG 102
	param set MAV_1_MODE 7
	param set MAV_1_RATE 1000
	param set SER_TEL2_BAUD 19200
	param set SYS_COMPANION 0
fi
<<<<<<< HEAD
if param compare SYS_COMPANION 338400
=======

###############################################################################
#                 End Setup for board specific configurations.                #
###############################################################################

if [ $MAVLINK_F == default ]
>>>>>>> 97f14edcbd3ff8526326d26d749656a8e8f309c9
then
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 1000
	param set SER_TEL2_BAUD 38400
	param set SYS_COMPANION 0
fi
<<<<<<< HEAD
if param compare SYS_COMPANION 538400
then
	param set MAV_1_CONFIG 102
	param set MAV_1_MODE 7
	param set MAV_1_RATE 1000
	param set SER_TEL2_BAUD 38400
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 57600
then
	param set MAV_1_CONFIG 102
	param set MAV_1_MODE 2
	param set MAV_1_RATE 5000
	param set SER_TEL2_BAUD 57600
	param set SYS_COMPANION 0
=======

if [ "x$MAVLINK_F" == xnone ]
then
else
	mavlink start ${MAVLINK_F}
fi

#
# MAVLink onboard / TELEM2
#
# XXX We need a better way for runtime eval of shell variables,
# but this works for now
if param compare SYS_COMPANION 10
then
	frsky_telemetry start -d ${MAVLINK_COMPANION_DEVICE}
else
	if ver hwcmp PX4FMU_V4 PX4FMU_V4PRO MINDPX_V2
	then
		# This is TELEM4 on Pixhawk 3 Pro
		frsky_telemetry start -d /dev/ttyS6 -t 15
	fi
>>>>>>> 97f14edcbd3ff8526326d26d749656a8e8f309c9
fi
if param compare SYS_COMPANION 157600
then
	param set MAV_1_CONFIG 102
	param set MAV_1_MODE 3
	param set MAV_1_RATE 1000
	param set SER_TEL2_BAUD 57600
	param set SYS_COMPANION 0
fi
<<<<<<< HEAD
if param compare SYS_COMPANION 257600
then
	param set MAV_1_CONFIG 102
	param set MAV_1_MODE 4
	param set MAV_1_RATE 5000
	param set SER_TEL2_BAUD 57600
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 357600
then
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 1000
	param set SER_TEL2_BAUD 57600
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 557600
then
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 1000
	param set MAV_1_MODE 7
	param set SER_TEL2_BAUD 57600
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 3115200
then
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 1000
	param set SER_TEL2_BAUD 115200
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 4115200
then
	# Iridium
	param set ISBD_CONFIG 102
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 5115200
then
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 1000
	param set MAV_1_MODE 7
	param set SER_TEL2_BAUD 115200
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 460800
then
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 5000
	param set MAV_1_MODE 2
	param set SER_TEL2_BAUD 460800
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 921600
then
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 80000
	param set MAV_1_MODE 2
	param set SER_TEL2_BAUD 921600
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 1921600
then
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 20000
	param set SER_TEL2_BAUD 921600
	param set SYS_COMPANION 0
fi
if param compare SYS_COMPANION 1500000
then
	param set MAV_1_CONFIG 102
	param set MAV_1_RATE 140000
	param set MAV_1_MODE 2
	param set SER_TEL2_BAUD 1500000
	param set SYS_COMPANION 0
fi

=======

#
# 19200 Baud Rate.
#
if param compare SYS_COMPANION 319200
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 19200 -r 1000 -f
fi
if param compare SYS_COMPANION 419200
then
	iridiumsbd start -d ${MAVLINK_COMPANION_DEVICE}
	mavlink start -d /dev/iridium -b 19200 -m iridium -r 10
fi
if param compare SYS_COMPANION 519200
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 19200 -m minimal -r 1000
fi

#
# 38400 Baud Rate.
#
if param compare SYS_COMPANION 338400
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 38400 -r 1000 -f
fi
if param compare SYS_COMPANION 538400
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 38400 -m minimal -r 1000
fi

#
# 57600 Baud Rate.
#
if param compare SYS_COMPANION 57600
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 57600 -m onboard -r 5000 -x -f
fi
if param compare SYS_COMPANION 157600
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 57600 -m osd -r 1000
fi
if param compare SYS_COMPANION 257600
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 57600 -m magic -r 5000 -x -f
fi
if param compare SYS_COMPANION 357600
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 57600 -r 1000 -f
fi
if param compare SYS_COMPANION 557600
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 57600 -m minimal -r 1000
fi

#
# 115200 Baud Rate.
#
if param compare SYS_COMPANION 3115200
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 115200 -r 1000 -f
fi
if param compare SYS_COMPANION 5115200
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 115200 -m minimal -r 1000
fi

#
# 460800 Baud Rate.
#
if param compare SYS_COMPANION 460800
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 460800 -m onboard -r 5000 -x -f
fi
if param compare SYS_COMPANION 6460800
then
	micrortps_client start -t UART -d /dev/ttyS2 -b 460800
fi

#
# 921600 Baud Rate.
#
if param compare SYS_COMPANION 921600
then
	if ver hwcmp AEROFC_V1
	then
		if protocol_splitter start ${MAVLINK_COMPANION_DEVICE}
		then
			mavlink start -d /dev/mavlink -b 921600 -m onboard -r 5000 -x
			micrortps_client start -d /dev/rtps -b 921600 -l -1 -s 2000
		else
			mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 921600 -m onboard -r 80000 -x -f
		fi
	else
		mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 921600 -m onboard -r 80000 -x -f
	fi
fi
if param compare SYS_COMPANION 1921600
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 921600 -r 20000
fi

#
# 1500000 Baud Rate.
#
if param compare SYS_COMPANION 1500000
then
	mavlink start -d ${MAVLINK_COMPANION_DEVICE} -b 1500000 -m onboard -r 10000 -x -f
fi
>>>>>>> 97f14edcbd3ff8526326d26d749656a8e8f309c9
